{% include 'toast.html' %}
<div class="bg-white shadow rounded p-4">
  <div class="flex items-center justify-between mb-4">
    <div>
      <h2 class="text-lg font-semibold">Enquiries</h2>
      <div class="text-sm text-gray-600 mt-1">Total submissions: {{ enquiry_count }}</div>
    </div>
    <div>
      <label class="flex items-center gap-2 text-sm cursor-pointer">
        <input 
          type="checkbox" 
          id="enable-enquiry-form" 
          {% if workspace.enable_enquiry_form %}checked{% endif %}
          onchange="updateEnquiryFormSetting(this)"
          class="w-4 h-4"
        />
        <span>{{ workspace.enable_enquiry_form|yesno:'Enabled,Disabled' }}</span>
      </label>
    </div>
  </div>

  <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800">
    <strong>Form Status:</strong> {% if workspace.enable_enquiry_form %}Enquiry form is <strong>enabled</strong> — visitors will see name/phone/email form before chatting.{% else %}Enquiry form is <strong>disabled</strong> — visitors can chat directly without submitting form.{% endif %}
  </div>

  {% if enquiries %}
  <div class="overflow-x-auto">
    <table class="w-full text-sm border-collapse">
      <thead>
        <tr class="border-b bg-gray-50">
          <th class="text-left p-2">Name</th>
          <th class="text-left p-2">Phone</th>
          <th class="text-left p-2">Email</th>
          <th class="text-left p-2">Submitted At</th>
        </tr>
      </thead>
      <tbody>
        {% for enquiry in enquiries %}
        <tr class="border-b hover:bg-gray-50">
          <td class="p-2">{{ enquiry.name|default:"—" }}</td>
          <td class="p-2">{{ enquiry.phone|default:"—" }}</td>
          <td class="p-2">{{ enquiry.email|default:"—" }}</td>
          <td class="p-2 text-xs text-gray-600">{{ enquiry.created_at|date:"Y-m-d H:i" }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination Controls -->
  {% if page_obj.has_other_pages %}
  <div class="mt-6 flex items-center justify-between">
    <div class="text-sm text-gray-600">
      Showing <strong>{{ page_obj.start_index }}</strong> to <strong>{{ page_obj.end_index }}</strong> of <strong>{{ enquiry_count }}</strong> enquiries
    </div>
    <div class="flex gap-2">
      <!-- Previous Page -->
      {% if page_obj.has_previous %}
        <a href="javascript:void(0)" onclick="loadEnquiriesPage(1)" class="px-3 py-2 border rounded bg-white hover:bg-gray-50 text-sm">First</a>
        <a href="javascript:void(0)" onclick="loadEnquiriesPage({{ page_obj.previous_page_number }})" class="px-3 py-2 border rounded bg-white hover:bg-gray-50 text-sm">← Previous</a>
      {% else %}
        <button disabled class="px-3 py-2 border rounded bg-gray-100 text-gray-400 text-sm cursor-not-allowed">First</button>
        <button disabled class="px-3 py-2 border rounded bg-gray-100 text-gray-400 text-sm cursor-not-allowed">← Previous</button>
      {% endif %}

      <!-- Page Numbers -->
      <div class="flex items-center gap-1">
        {% for num in page_obj.paginator.page_range %}
          {% if page_obj.number == num %}
            <span class="px-3 py-2 border rounded bg-blue-500 text-white font-semibold text-sm">{{ num }}</span>
          {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <a href="javascript:void(0)" onclick="loadEnquiriesPage({{ num }})" class="px-3 py-2 border rounded bg-white hover:bg-gray-50 text-sm">{{ num }}</a>
          {% endif %}
        {% endfor %}
      </div>

      <!-- Next Page -->
      {% if page_obj.has_next %}
        <a href="javascript:void(0)" onclick="loadEnquiriesPage({{ page_obj.next_page_number }})" class="px-3 py-2 border rounded bg-white hover:bg-gray-50 text-sm">Next →</a>
        <a href="javascript:void(0)" onclick="loadEnquiriesPage({{ page_obj.paginator.num_pages }})" class="px-3 py-2 border rounded bg-white hover:bg-gray-50 text-sm">Last</a>
      {% else %}
        <button disabled class="px-3 py-2 border rounded bg-gray-100 text-gray-400 text-sm cursor-not-allowed">Next →</button>
        <button disabled class="px-3 py-2 border rounded bg-gray-100 text-gray-400 text-sm cursor-not-allowed">Last</button>
      {% endif %}
    </div>
  </div>
  {% endif %}
  {% else %}
  <div class="text-center p-6 text-gray-500">
    <p>No enquiries yet.</p>
    <p class="text-xs mt-2">When visitors submit the form (if enabled), their information will appear here.</p>
  </div>
  {% endif %}
</div>

<script>
function updateEnquiryFormSetting(checkbox) {
  const enabled = checkbox.checked;
  const formData = new FormData();
  formData.append('enable_enquiry_form', enabled ? '1' : '0');
  
  fetch('{% url "dashboard:partial_enquiries" %}', {
    method: 'POST',
    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
    body: formData
  })
  .then(response => response.text())
  .then(html => {
    document.getElementById('main').innerHTML = html;
  })
  .catch(err => console.error('Error:', err));
}

function loadEnquiriesPage(pageNum) {
  const url = `{% url "dashboard:partial_enquiries" %}?page=${pageNum}`;
  
  fetch(url, {
    method: 'GET',
    headers: { 'X-Requested-With': 'XMLHttpRequest' }
  })
  .then(response => response.text())
  .then(html => {
    document.getElementById('main').innerHTML = html;
    // Scroll to top of main content
    const mainElement = document.getElementById('main');
    if (mainElement) {
      mainElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  })
  .catch(err => console.error('Error loading page:', err));
}
</script>
