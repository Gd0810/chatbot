<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Redbot Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  
  <!-- Google Font - Outfit -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Iconify for icons -->
  <script src="https://code.iconify.design/3/3.1.0/iconify.min.js"></script>
  <script src="https://code.iconify.design/iconify-icon/2.1.0/iconify-icon.min.js"></script>
  
  <!-- Emoji Picker Library -->
  <script src="https://cdn.jsdelivr.net/npm/emoji-mart@latest/dist/browser.js"></script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* Theme variables */
    :root {
      --bg-primary: #f5f5f5;
      --bg-secondary: #ffffff;
      --text-primary: #1f1f1f;
      --text-secondary: #5f6368;
      --border-color: #e0e0e0;
      --hover-bg: #f1f3f4;
      --active-bg: #e8f0fe;
      --active-color: #1a73e8;
      --toggle-bg: #e8eaed;
      --toggle-active: #1a73e8;
    }
    
    [data-theme="dark"] {
      --bg-primary: #1f1f1f;
      --bg-secondary: #2d2d2d;
      --text-primary: #e8eaed;
      --text-secondary: #9aa0a6;
      --border-color: #3c4043;
      --hover-bg: #3c4043;
      --active-bg: #3c4043;
      --active-color: #8ab4f8;
      --toggle-bg: #3c4043;
      --toggle-active: #8ab4f8;
    }
    
    * {
      font-family: 'Outfit', sans-serif;
    }
    
    body {
      background-color: var(--bg-primary);
      color: var(--text-primary);
    }
    
    /* Mobile menu button */
    .mobile-menu-button {
      display: none;
      position: fixed;
      top: 16px;
      left: 16px;
      z-index: 1001;
      background-color: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 12px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: all 0.2s;
    }
    
    .mobile-menu-button:hover {
      background-color: var(--hover-bg);
    }
    
    .mobile-menu-button:active {
      transform: scale(0.95);
    }
    
    /* Overlay for mobile */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .sidebar-overlay.active {
      opacity: 1;
    }
    
    .sidebar {
      background-color: var(--bg-secondary);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease-in-out;
    }
    
    .nav-link {
      color: var(--text-primary);
      transition: all 0.2s;
      position: relative;
    }
    
    .nav-link:hover {
      background-color: var(--hover-bg);
    }
    
    .nav-link.active {
      background-color: var(--active-bg);
      color: var(--active-color);
    }
    
    .nav-link.active iconify-icon {
      color: var(--active-color);
    }
    
    .section-label {
      color: var(--text-secondary);
      font-weight: 500;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      font-size: 11px;
    }
    
    /* Dropdown parent */
    .nav-parent {
      color: var(--text-primary);
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .nav-parent:hover {
      background-color: var(--hover-bg);
    }
    
    .nav-parent.active {
      background-color: var(--active-bg);
      color: var(--active-color);
    }
    
    .nav-parent.active iconify-icon {
      color: var(--active-color);
    }
    
    .nav-parent-arrow {
      transition: transform 0.3s;
      color: var(--text-secondary);
    }
    
    .nav-parent.open .nav-parent-arrow {
      transform: rotate(180deg);
    }
    
    .nav-children {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    
    .nav-children.open {
      max-height: 200px;
    }
    
    .nav-child {
      padding-left: 52px;
      font-size: 14px;
      color: var(--text-primary);
      transition: all 0.2s;
    }
    
    .nav-child:hover {
      background-color: var(--hover-bg);
    }
    
    .nav-child.active {
      background-color: var(--active-bg);
      color: var(--active-color);
    }
    
    .nav-child.active iconify-icon {
      color: var(--active-color);
    }
    
    /* Account dropdown at bottom */
    .account-section {
      margin-top: auto;
      border-top: 1px solid var(--border-color);
      padding: 12px;
    }
    
    .account-trigger {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      border-radius: 12px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .account-trigger:hover {
      background-color: var(--hover-bg);
    }
    
    .account-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background-color: var(--toggle-active);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 14px;
    }
    
    .account-info {
      flex: 1;
      min-width: 0;
    }
    
    .account-name {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .account-email {
      font-size: 12px;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .dropdown-arrow {
      color: var(--text-secondary);
      transition: transform 0.3s;
    }
    
    .dropdown-arrow.open {
      transform: rotate(180deg);
    }
    
    .account-dropdown {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
      margin-top: 8px;
    }
    
    .account-dropdown.open {
      max-height: 200px;
    }
    
    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.2s;
      margin-bottom: 4px;
    }
    
    .dropdown-item:hover {
      background-color: var(--hover-bg);
    }
    
    .dropdown-item-text {
      flex: 1;
      font-size: 14px;
      font-weight: 500;
    }
    
    /* Android-style toggle switch */
    .toggle-switch {
      position: relative;
      width: 52px;
      height: 32px;
      background-color: var(--toggle-bg);
      border-radius: 16px;
      transition: background-color 0.3s;
      cursor: pointer;
      flex-shrink: 0;
    }
    
    .toggle-switch.active {
      background-color: var(--toggle-active);
    }
    
    .toggle-thumb {
      position: absolute;
      top: 4px;
      left: 4px;
      width: 24px;
      height: 24px;
      background-color: #ffffff;
      border-radius: 50%;
      transition: transform 0.3s, background-color 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .toggle-switch.active .toggle-thumb {
      transform: translateX(20px);
    }
    
    .toggle-icon {
      font-size: 14px;
      color: var(--text-secondary);
    }
    
    .toggle-switch.active .toggle-icon {
      color: var(--toggle-active);
    }
    
    /* Responsive styles */
    @media (max-width: 1024px) {
      .mobile-menu-button {
        display: block;
      }
      
      .sidebar-overlay {
        display: block;
      }
      
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100vh;
        z-index: 1000;
        transform: translateX(-100%);
        width: 280px;
        max-width: 85vw;
        overflow-y: auto;
      }
      
      .sidebar.active {
        transform: translateX(0);
      }
      
      main {
        padding-top: 70px !important;
      }
    }
    
    @media (max-width: 640px) {
      .sidebar {
        width: 100%;
        max-width: 100vw;
      }
      
      main {
        padding: 70px 16px 16px 16px !important;
      }
      
      .account-info {
        display: none;
      }
      
      .account-trigger {
        justify-content: center;
      }
    }
    
    /* Desktop styles */
    @media (min-width: 1025px) {
      .sidebar {
        position: relative;
        width: 256px;
        min-height: 100vh;
      }
    }
  </style>
</head>
<body class="min-h-screen">
  <!-- Mobile Menu Button -->
  <button class="mobile-menu-button" onclick="toggleMobileSidebar()" aria-label="Toggle menu">
    <iconify-icon icon="material-symbols:menu" width="24" height="24" style="color: var(--text-primary)"></iconify-icon>
  </button>
  
  <!-- Sidebar Overlay for Mobile -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeMobileSidebar()"></div>
  
  <div class="flex">
    <aside class="sidebar" id="sidebar">
      <nav class="px-2 flex-1">
        <div class="section-label px-2 mt-4 mb-2">Profile</div>
        <a class="nav-link block px-3 py-2 rounded flex items-center gap-2"
           hx-get="{% url 'dashboard:partial_account' %}" hx-target="#main" hx-swap="innerHTML"
           onclick="setActiveLink(this); closeMobileSidebar()">
          <iconify-icon icon="material-symbols:account-circle-outline" width="20" height="20"></iconify-icon>
          <span>Account</span>
        </a>
        <a class="nav-link block px-3 py-2 rounded flex items-center gap-2"
           hx-get="{% url 'dashboard:partial_plan' %}" hx-target="#main" hx-swap="innerHTML"
           onclick="setActiveLink(this); closeMobileSidebar()">
          <iconify-icon icon="material-symbols:credit-card-outline" width="20" height="20"></iconify-icon>
          <span>Your Plan</span>
        </a>

        <div class="section-label px-2 mt-6 mb-2">Bot</div>
        <a class="nav-link block px-3 py-2 rounded flex items-center gap-2"
          hx-get="{% url 'dashboard:partial_bots' %}" hx-target="#main" hx-swap="innerHTML"
          onclick="setActiveLink(this); closeMobileSidebar()">
          <iconify-icon icon="material-symbols:smart-toy-outline" width="20" height="20"></iconify-icon>
          <span>Manage Bots</span>
        </a>
        <a class="nav-link block px-3 py-2 rounded flex items-center gap-2"
          hx-get="{% url 'dashboard:partial_bot_style' %}" hx-target="#main" hx-swap="innerHTML"
          onclick="setActiveLink(this); closeMobileSidebar()">
          <iconify-icon icon="material-symbols:palette-outline" width="20" height="20"></iconify-icon>
          <span>Bot Styling</span>
        </a>

        {% if plan %}
          {% if plan.includes_live %}
        <div class="section-label px-2 mt-6 mb-2">Conversation</div>
        <a class="nav-link block px-3 py-2 rounded flex items-center gap-2"
           hx-get="{% url 'dashboard:partial_live' %}" hx-target="#main" hx-swap="innerHTML"
           onclick="setActiveLink(this); closeMobileSidebar()">
          <iconify-icon icon="material-symbols:chat-outline" width="20" height="20"></iconify-icon>
          <span>Live Chat</span>
        </a>
          {% endif %}

          {% if plan.includes_ai or plan.includes_qa or plan.includes_live %}
        <div class="section-label px-2 mt-6 mb-2">Your Data</div>
            {% if plan.includes_ai %}
        <div class="nav-parent block px-3 py-2 rounded flex items-center gap-2" id="aiKnowledgeParent" onclick="toggleNavDropdown('aiKnowledgeParent')">
          <iconify-icon icon="material-symbols:psychology-outline" width="20" height="20"></iconify-icon>
          <span style="flex: 1;">AI Knowledge</span>
          <iconify-icon class="nav-parent-arrow" icon="material-symbols:keyboard-arrow-down" width="20" height="20"></iconify-icon>
        </div>
        <div class="nav-children" id="aiKnowledgeChildren">
          <a class="nav-child block px-3 py-2 rounded flex items-center gap-2"
             hx-get="{% url 'dashboard:partial_knowledge' %}" hx-target="#main" hx-swap="innerHTML"
             onclick="setActiveLink(this, 'aiKnowledgeParent'); closeMobileSidebar()">
            <iconify-icon icon="material-symbols:folder-outline" width="18" height="18"></iconify-icon>
            <span>Knowledge Base</span>
          </a>
            {% if workspace.enable_website_datafetcher %}
          <a class="nav-child block px-3 py-2 rounded flex items-center gap-2"
             hx-get="{% url 'dashboard:partial_website_datafetcher' %}" hx-target="#main" hx-swap="innerHTML"
             onclick="setActiveLink(this, 'aiKnowledgeParent'); closeMobileSidebar()">
            <iconify-icon icon="material-symbols:language" width="18" height="18"></iconify-icon>
            <span>Website Datafetcher</span>
          </a>
            {% endif %}
        </div>
            {% endif %}
            {% if plan.includes_qa %}
        <a class="nav-link block px-3 py-2 rounded flex items-center gap-2"
           hx-get="{% url 'dashboard:partial_qa' %}" hx-target="#main" hx-swap="innerHTML"
           onclick="setActiveLink(this); closeMobileSidebar()">
          <iconify-icon icon="material-symbols:quiz-outline" width="20" height="20"></iconify-icon>
          <span>Q&A Knowledge</span>
        </a>
            {% endif %}
        <a class="nav-link block px-3 py-2 rounded flex items-center gap-2"
           hx-get="{% url 'dashboard:partial_enquiries' %}" hx-target="#main" hx-swap="innerHTML"
           onclick="setActiveLink(this); closeMobileSidebar()">
          <iconify-icon icon="material-symbols:mail-outline" width="20" height="20"></iconify-icon>
          <span>Enquiries</span>
        </a>
          {% endif %}
        {% else %}
          {# No active plan - show all links #}
        <div class="section-label px-2 mt-6 mb-2">Conversation</div>
        <a class="nav-link block px-3 py-2 rounded flex items-center gap-2"
           hx-get="{% url 'dashboard:partial_live' %}" hx-target="#main" hx-swap="innerHTML"
           onclick="setActiveLink(this); closeMobileSidebar()">
          <iconify-icon icon="material-symbols:chat-outline" width="20" height="20"></iconify-icon>
          <span>Live Chat</span>
        </a>
        
        <div class="section-label px-2 mt-6 mb-2">Your Data</div>
        <div class="nav-parent block px-3 py-2 rounded flex items-center gap-2" id="aiKnowledgeParent" onclick="toggleNavDropdown('aiKnowledgeParent')">
          <iconify-icon icon="material-symbols:psychology-outline" width="20" height="20"></iconify-icon>
          <span style="flex: 1;">AI Knowledge</span>
          <iconify-icon class="nav-parent-arrow" icon="material-symbols:keyboard-arrow-down" width="20" height="20"></iconify-icon>
        </div>
        <div class="nav-children" id="aiKnowledgeChildren">
          <a class="nav-child block px-3 py-2 rounded flex items-center gap-2"
             hx-get="{% url 'dashboard:partial_knowledge' %}" hx-target="#main" hx-swap="innerHTML"
             onclick="setActiveLink(this, 'aiKnowledgeParent'); closeMobileSidebar()">
            <iconify-icon icon="material-symbols:folder-outline" width="18" height="18"></iconify-icon>
            <span>Knowledge Base</span>
          </a>
          <a class="nav-child block px-3 py-2 rounded flex items-center gap-2"
             hx-get="{% url 'dashboard:partial_website_datafetcher' %}" hx-target="#main" hx-swap="innerHTML"
             onclick="setActiveLink(this, 'aiKnowledgeParent'); closeMobileSidebar()">
            <iconify-icon icon="material-symbols:language" width="18" height="18"></iconify-icon>
            <span>Website Datafetcher</span>
          </a>
        </div>
        <a class="nav-link block px-3 py-2 rounded flex items-center gap-2"
           hx-get="{% url 'dashboard:partial_qa' %}" hx-target="#main" hx-swap="innerHTML"
           onclick="setActiveLink(this); closeMobileSidebar()">
          <iconify-icon icon="material-symbols:quiz-outline" width="20" height="20"></iconify-icon>
          <span>Q&A Knowledge</span>
        </a>
        <a class="nav-link block px-3 py-2 rounded flex items-center gap-2"
           hx-get="{% url 'dashboard:partial_enquiries' %}" hx-target="#main" hx-swap="innerHTML"
           onclick="setActiveLink(this); closeMobileSidebar()">
          <iconify-icon icon="material-symbols:mail-outline" width="20" height="20"></iconify-icon>
          <span>Enquiries</span>
        </a>
        {% endif %}
      </nav>
      
      <!-- Account Section at Bottom -->
      <div class="account-section">
        <div class="account-trigger" onclick="toggleAccountDropdown()">
          <div class="account-avatar">
            <span>{{ user.first_name.0|default:user.username.0|upper }}</span>
          </div>
          <div class="account-info">
            <div class="account-name">{{ user.get_full_name|default:user.username }}</div>
            <div class="account-email">{{ user.email }}</div>
          </div>
          <iconify-icon class="dropdown-arrow" id="dropdownArrow" icon="material-symbols:keyboard-arrow-down" width="24" height="24"></iconify-icon>
        </div>
        
        <div class="account-dropdown" id="accountDropdown">
          <div class="dropdown-item" onclick="toggleTheme()">
            <iconify-icon id="themeMenuIcon" icon="material-symbols:light-mode-outline" width="20" height="20" style="color: var(--text-primary)"></iconify-icon>
            <span class="dropdown-item-text" id="themeMenuText">Light theme</span>
            <div class="toggle-switch" id="themeToggle">
              <div class="toggle-thumb">
                <iconify-icon class="toggle-icon" id="themeToggleIcon" icon="material-symbols:wb-sunny-rounded" width="16" height="16"></iconify-icon>
              </div>
            </div>
          </div>
          
          <a class="dropdown-item" href="{% url 'accounts:logout' %}" style="text-decoration: none; color: inherit;">
            <iconify-icon icon="material-symbols:logout" width="20" height="20" style="color: var(--toggle-active)"></iconify-icon>
            <span class="dropdown-item-text" style="color: var(--toggle-active)">Logout</span>
          </a>
        </div>
      </div>
    </aside>
    <main class="flex-1 p-6">
      {% block content %}{% endblock %}
      <div id="main"></div>
    </main>
  </div>

  <script>
    // Mobile sidebar functions
    function toggleMobileSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      
      sidebar.classList.toggle('active');
      overlay.classList.toggle('active');
      
      // Prevent body scroll when sidebar is open
      if (sidebar.classList.contains('active')) {
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = '';
      }
    }
    
    function closeMobileSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      
      sidebar.classList.remove('active');
      overlay.classList.remove('active');
      document.body.style.overflow = '';
    }
    
    // Navigation dropdown toggle
    function toggleNavDropdown(parentId) {
      const parent = document.getElementById(parentId);
      const children = document.getElementById(parentId.replace('Parent', 'Children'));
      
      parent.classList.toggle('open');
      children.classList.toggle('open');
    }
    
    // Active link management
    function setActiveLink(element, parentId) {
      // Remove active from all links
      document.querySelectorAll('.nav-link, .nav-child, .nav-parent').forEach(link => {
        link.classList.remove('active');
      });
      
      // Add active to clicked element
      element.classList.add('active');
      
      // If it's a child, also activate parent and open dropdown
      if (parentId) {
        const parent = document.getElementById(parentId);
        const children = document.getElementById(parentId.replace('Parent', 'Children'));
        
        parent.classList.add('open', 'active');
        children.classList.add('open');
      }
    }
    
    // Account dropdown toggle
    function toggleAccountDropdown() {
      const dropdown = document.getElementById('accountDropdown');
      const arrow = document.getElementById('dropdownArrow');
      
      dropdown.classList.toggle('open');
      arrow.classList.toggle('open');
    }
    
    // Theme management
    function updateThemeUI(theme) {
       const menuIcon = document.getElementById('themeMenuIcon');
       const menuText = document.getElementById('themeMenuText');
       const toggleBtn = document.getElementById('themeToggle');
       const toggleIcon = document.getElementById('themeToggleIcon');
       
       if (theme === 'dark') {
          menuIcon.setAttribute('icon', 'material-symbols:dark-mode-outline');
          menuText.textContent = 'Dark theme';
          toggleBtn.classList.add('active');
          toggleIcon.setAttribute('icon', 'material-symbols:dark-mode');
       } else {
          menuIcon.setAttribute('icon', 'material-symbols:light-mode-outline');
          menuText.textContent = 'Light theme';
          toggleBtn.classList.remove('active');
          toggleIcon.setAttribute('icon', 'material-symbols:wb-sunny-rounded');
       }
    }

    function toggleTheme() {
      const html = document.documentElement;
      const currentTheme = html.getAttribute('data-theme');
      
      if (currentTheme === 'dark') {
        html.removeAttribute('data-theme');
        localStorage.setItem('theme', 'light');
        updateThemeUI('light');
      } else {
        html.setAttribute('data-theme', 'dark');
        localStorage.setItem('theme', 'dark');
        updateThemeUI('dark');
      }
    }
    
    // Load saved theme on page load
    document.addEventListener('DOMContentLoaded', function() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        updateThemeUI('dark');
      } else {
        updateThemeUI('light');
      }
    });

    // CSRF for HTMX
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    document.body.addEventListener('htmx:configRequest', (e) => {
      const csrf = getCookie('csrftoken');
      if (csrf) e.detail.headers['X-CSRFToken'] = csrf;
    });

    // Enquiries Global Functions
    window.updateEnquiryFormSetting = function(checkbox) {
        const enabled = checkbox.checked;
        const vals = { 'enable_enquiry_form': enabled ? '1' : '0' };
        htmx.ajax('POST', '{% url "dashboard:partial_enquiries" %}', {
             target: '#main',
             values: vals,
             headers: { 'X-CSRFToken': getCookie('csrftoken') }
        });
    };

    window.loadEnquiriesPage = function(pageNum) {
       htmx.ajax('GET', `{% url "dashboard:partial_enquiries" %}?page=${pageNum}`, '#main');
    };
    
    // Close sidebar on window resize to desktop size
    window.addEventListener('resize', function() {
      if (window.innerWidth > 1024) {
        closeMobileSidebar();
      }
    });
  </script>
</body>
</html>