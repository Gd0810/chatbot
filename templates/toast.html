<div id="toast-container" class="fixed top-4 right-4 z-50 max-w-xs space-y-3">
    {% if messages %}
        {% for message in messages %}
            {% if message.tags == 'success' %}
                <div class="animate-toast bg-white text-sm rounded-lg shadow-lg flex items-center p-4 border-l-4 border-green-500 relative overflow-hidden" role="alert">
                    <div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-green-500 bg-green-100 rounded-lg">
                        <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                    </div>
                    <div class="ml-3 text-sm font-normal text-gray-700">{{ message }}</div>
                    <button type="button" class="ml-4 -mx-1.5 -my-1.5 bg-white text-gray-400 hover:text-gray-900 rounded-lg p-1.5 hover:bg-gray-100 inline-flex items-center justify-center h-8 w-8" onclick="this.parentElement.remove()">
                        <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                        </svg>
                    </button>
                </div>
            {% elif message.tags == 'error' %}
                <div class="animate-toast bg-white text-sm rounded-lg shadow-lg flex items-center p-4 border-l-4 border-red-500 relative overflow-hidden" role="alert">
                    <div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-red-500 bg-red-100 rounded-lg">
                        <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
                        </svg>
                    </div>
                    <div class="ml-3 text-sm font-normal text-gray-700">{{ message }}</div>
                    <button type="button" class="ml-4 -mx-1.5 -my-1.5 bg-white text-gray-400 hover:text-gray-900 rounded-lg p-1.5 hover:bg-gray-100 inline-flex items-center justify-center h-8 w-8" onclick="this.parentElement.remove()">
                        <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                        </svg>
                    </button>
                </div>
            {% elif message.tags == 'info' %}
                <div class="animate-toast bg-white text-sm rounded-lg shadow-lg flex items-center p-4 border-l-4 border-blue-500 relative overflow-hidden" role="alert">
                    <div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-blue-500 bg-blue-100 rounded-lg">
                        <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z"/>
                        </svg>
                    </div>
                    <div class="ml-3 text-sm font-normal text-gray-700">{{ message }}</div>
                    <button type="button" class="ml-4 -mx-1.5 -my-1.5 bg-white text-gray-400 hover:text-gray-900 rounded-lg p-1.5 hover:bg-gray-100 inline-flex items-center justify-center h-8 w-8" onclick="this.parentElement.remove()">
                        <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                        </svg>
                    </button>
                </div>
            {% else %}
                <div class="animate-toast bg-white text-sm rounded-lg shadow-lg flex items-center p-4 border-l-4 border-gray-500 relative overflow-hidden" role="alert">
                    <div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-gray-500 bg-gray-100 rounded-lg">
                        <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
                        </svg>
                    </div>
                    <div class="ml-3 text-sm font-normal text-gray-700">{{ message }}</div>
                    <button type="button" class="ml-4 -mx-1.5 -my-1.5 bg-white text-gray-400 hover:text-gray-900 rounded-lg p-1.5 hover:bg-gray-100 inline-flex items-center justify-center h-8 w-8" onclick="this.parentElement.remove()">
                        <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                        </svg>
                    </button>
                </div>
            {% endif %}
        {% endfor %}
    {% endif %}
</div>

<style>
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes fadeOut {
        from {
            opacity: 1;
        }
        to {
            opacity: 0;
        }
    }

    .animate-toast {
        animation: slideIn 0.3s ease-out;
    }

    .fade-out {
        animation: fadeOut 0.3s ease-out forwards;
    }
</style>

<script>
    (function() {
        const PROCESSING_ATTR = 'data-toast-processing';
        const TOAST_DURATION = 5000;

        const ensureContainer = () => {
            const containers = document.querySelectorAll('#toast-container');
            let container = containers[0] || null;

            containers.forEach((node, index) => {
                if (index === 0) {
                    container = node;
                } else {
                    while (node.firstChild) {
                        container.appendChild(node.firstChild);
                    }
                    node.remove();
                }
            });

            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.className = 'fixed top-4 right-4 z-50 max-w-xs space-y-3';
                document.body.appendChild(container);
            } else if (container.parentElement !== document.body) {
                document.body.appendChild(container);
            }

            return container;
        };

        const fadeOutAndRemove = (toast) => {
            if (!toast) return;
            toast.classList.add('fade-out');
            setTimeout(() => toast.remove(), 300);
        };

        const initToast = (toast) => {
            if (!toast || toast.dataset.toastInit === 'true' || toast.hasAttribute(PROCESSING_ATTR)) {
                return;
            }
            toast.dataset.toastInit = 'true';

            setTimeout(() => {
                fadeOutAndRemove(toast);
            }, TOAST_DURATION);

            const progress = document.createElement('div');
            progress.className = 'absolute bottom-0 left-0 h-1 w-full bg-gray-200';
            progress.innerHTML = '<div class="h-1 bg-gray-400" style="width: 100%; transition: width 5s linear;"></div>';
            toast.appendChild(progress);
            requestAnimationFrame(() => {
                progress.firstChild.style.width = '0';
            });
        };

        const initToasts = (root = document) => {
            root.querySelectorAll('#toast-container [role="alert"]').forEach(initToast);
        };

        const showProcessingToast = (message) => {
            if (!message) return;
            const container = ensureContainer();
            let toast = container.querySelector(`[${PROCESSING_ATTR}="true"]`);
            if (!toast) {
                toast = document.createElement('div');
                toast.setAttribute(PROCESSING_ATTR, 'true');
                toast.setAttribute('role', 'alert');
                toast.className = 'animate-toast bg-white text-sm rounded-lg shadow-lg flex items-center p-4 border-l-4 border-blue-500 relative overflow-hidden';
                toast.innerHTML = `
                    <div class="inline-flex items-center justify-center flex-shrink-0 w-8 h-8 text-blue-500 bg-blue-100 rounded-full">
                        <svg class="w-5 h-5 animate-spin" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                        </svg>
                    </div>
                    <div class="ml-3 text-sm font-medium text-gray-700 redbot-processing-text"></div>
                `;
                container.appendChild(toast);
            }
            const textNode = toast.querySelector('.redbot-processing-text');
            if (textNode) {
                textNode.textContent = message;
            }
        };

        const dismissProcessingToast = () => {
            const container = document.getElementById('toast-container');
            if (!container) return;
            container.querySelectorAll(`[${PROCESSING_ATTR}="true"]`).forEach(toast => fadeOutAndRemove(toast));
        };

        const attachProcessingHandlers = (root = document) => {
            const forms = root.querySelectorAll('form[data-processing-message]');
            forms.forEach(form => {
                if (form.dataset.processingBound === 'true') return;
                form.dataset.processingBound = 'true';

                form.addEventListener('submit', () => {
                    showProcessingToast(form.dataset.processingMessage);
                });
                ['htmx:afterRequest', 'htmx:responseError', 'htmx:sendError'].forEach(eventName => {
                    form.addEventListener(eventName, dismissProcessingToast);
                });
            });
        };

        const refreshBindings = (root = document) => {
            ensureContainer();
            initToasts(root);
            attachProcessingHandlers(root);
        };

        if (!window.__redbotToastInit) {
            window.__redbotToastInit = () => refreshBindings();
        } else {
            window.__redbotToastInit();
            return;
        }

        document.addEventListener('DOMContentLoaded', () => {
            refreshBindings();
        });

        document.body.addEventListener('htmx:afterSwap', (event) => {
            const root = event.detail && event.detail.elt ? event.detail.elt : document;
            refreshBindings(root);
            dismissProcessingToast();
        });

        document.body.addEventListener('htmx:responseError', dismissProcessingToast);
        document.body.addEventListener('htmx:sendError', dismissProcessingToast);
    })();
</script>