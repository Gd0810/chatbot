<!-- templates/dashboard/partials/website_datafetcher.html -->
{% include 'toast.html' %}
<div class="bg-white shadow rounded p-6">
  <h2 class="text-2xl font-semibold mb-4">Website Data Fetcher</h2>
  <p class="text-gray-600 mb-6">Crawl a website and extract content organized by sections.</p>

  <form id="crawler-form" class="space-y-4 mb-6">
    {% csrf_token %}
    <div>
      <label for="url" class="block text-sm font-medium text-gray-700 mb-1">Website URL *</label>
      <input type="url" id="url" name="url" required
             placeholder="https://example.com"
             class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
    </div>

    <div>
      <label for="max_pages" class="block text-sm font-medium text-gray-700 mb-1">
        Max Pages: <span id="max-pages-value">30</span>
      </label>
      <input type="range" id="max_pages" name="max_pages" min="1" max="100" value="30"
             class="w-full"
             oninput="document.getElementById('max-pages-value').textContent = this.value">
    </div>

    <button type="submit" id="crawl-btn"
            class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
      <span id="btn-text">Crawl Website</span>
      <span id="btn-loading" class="hidden">Crawling...</span>
    </button>
  </form>

  <!-- Results Container -->
  <div id="results-container" class="hidden">
    <div class="border-t pt-6">
      <h3 class="text-lg font-semibold mb-4">Results (<span id="total-pages">0</span> pages found)</h3>
      
      <!-- Page Selector -->
      <div class="mb-4">
        <label for="page-selector" class="block text-sm font-medium text-gray-700 mb-2">Select Page:</label>
        <select id="page-selector" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500">
        </select>
      </div>

      <!-- Page Content -->
      <div id="page-content" class="space-y-6">
        <!-- Sections will be inserted here -->
      </div>
    </div>
  </div>
</div>

<script>
let crawlData = [];

document.getElementById('crawler-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const url = document.getElementById('url').value;
  const maxPages = document.getElementById('max_pages').value;
  const btn = document.getElementById('crawl-btn');
  const btnText = document.getElementById('btn-text');
  const btnLoading = document.getElementById('btn-loading');
  
  // Show loading state
  btn.disabled = true;
  btnText.classList.add('hidden');
  btnLoading.classList.remove('hidden');
  
  try {
    const formData = new FormData();
    formData.append('url', url);
    formData.append('max_pages', maxPages);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    const response = await fetch('{% url "dashboard:website_datafetcher_crawl" %}', {
      method: 'POST',
      body: formData
    });
    
    const data = await response.json();
    
    if (data.success) {
      crawlData = data.pages;
      displayResults(data.pages, data.total);
    } else {
      alert('Error: ' + (data.error || 'Unknown error'));
    }
  } catch (error) {
    alert('Error: ' + error.message);
  } finally {
    btn.disabled = false;
    btnText.classList.remove('hidden');
    btnLoading.classList.add('hidden');
  }
});

function displayResults(pages, total) {
  document.getElementById('results-container').classList.remove('hidden');
  document.getElementById('total-pages').textContent = total;
  
  const selector = document.getElementById('page-selector');
  selector.innerHTML = '';
  
  pages.forEach((page, index) => {
    const option = document.createElement('option');
    option.value = index;
    option.textContent = `${page.title} (${page.path})`;
    selector.appendChild(option);
  });
  
  selector.addEventListener('change', function() {
    showPage(parseInt(this.value));
  });
  
  if (pages.length > 0) {
    showPage(0);
  }
}

function showPage(index) {
  const page = crawlData[index];
  const container = document.getElementById('page-content');
  container.innerHTML = '';
  
  const pageInfo = document.createElement('div');
  pageInfo.className = 'bg-gray-50 p-4 rounded-md mb-4';
  pageInfo.innerHTML = `
    <h4 class="font-semibold text-lg">${page.title}</h4>
    <p class="text-sm text-gray-600 mt-1">URL: <a href="${page.url}" target="_blank" class="text-indigo-600 hover:underline">${page.url}</a></p>
    <p class="text-sm text-gray-600">Path: ${page.path}</p>
  `;
  container.appendChild(pageInfo);
  
  page.sections.forEach((section, sectionIndex) => {
    const sectionDiv = document.createElement('div');
    sectionDiv.className = 'border border-gray-200 rounded-md p-4';
    
    const heading = document.createElement('h5');
    heading.className = 'font-semibold text-md mb-2';
    heading.textContent = section.heading;
    sectionDiv.appendChild(heading);
    
    const content = document.createElement('pre');
    content.className = 'text-sm text-gray-700 whitespace-pre-wrap font-sans mb-3';
    content.textContent = section.content || '(No content)';
    sectionDiv.appendChild(content);
    
    const copyBtn = document.createElement('button');
    copyBtn.className = 'px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 text-sm';
    copyBtn.innerHTML = '<iconify-icon icon="mdi:content-copy" class="mr-1"></iconify-icon> Copy';
    copyBtn.onclick = function() {
      copyToClipboard(section.heading, section.content, copyBtn);
    };
    sectionDiv.appendChild(copyBtn);
    
    container.appendChild(sectionDiv);
  });
}

function copyToClipboard(heading, content, button) {
  const text = `# ${heading}\n\n${content}`;
  
  navigator.clipboard.writeText(text).then(() => {
    const originalHTML = button.innerHTML;
    button.innerHTML = '<iconify-icon icon="mdi:check" class="mr-1"></iconify-icon> Copied!';
    button.classList.remove('bg-gray-200', 'hover:bg-gray-300');
    button.classList.add('bg-green-200');
    
    setTimeout(() => {
      button.innerHTML = originalHTML;
      button.classList.remove('bg-green-200');
      button.classList.add('bg-gray-200', 'hover:bg-gray-300');
    }, 2000);
  }).catch(err => {
    alert('Failed to copy: ' + err);
  });
}
</script>
