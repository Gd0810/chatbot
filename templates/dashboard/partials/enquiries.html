{% include 'toast.html' %}

<div class="bg-white shadow rounded p-4">

  <!-- Header -->
  <div class="flex items-center justify-between mb-4">
    <div>
      <h2 class="text-lg font-semibold">Enquiries</h2>
      <div class="text-sm text-gray-600 mt-1">
        Total submissions: {{ enquiry_count }}
      </div>
    </div>

    <label class="flex items-center gap-2 text-sm cursor-pointer">
      <input
        type="checkbox"
        {% if workspace.enable_enquiry_form %}checked{% endif %}
        onchange="updateEnquiryFormSetting(this)"
        class="w-4 h-4"
      />
      <span>{{ workspace.enable_enquiry_form|yesno:"Enabled,Disabled" }}</span>
    </label>
  </div>

  <!-- Status -->
  <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800">
    <strong>Form Status:</strong>
    {% if workspace.enable_enquiry_form %}
      Enquiry form is <strong>enabled</strong> â€” visitors will see the form before chat.
    {% else %}
      Enquiry form is <strong>disabled</strong> â€” visitors can chat directly.
    {% endif %}
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-gray-50 p-4 rounded border">
      <div class="text-xs uppercase text-gray-500 font-semibold">Today</div>
      <div class="text-2xl font-bold mt-1">{{ count_today }}</div>
    </div>
    <div class="bg-gray-50 p-4 rounded border">
      <div class="text-xs uppercase text-gray-500 font-semibold">This Month</div>
      <div class="text-2xl font-bold mt-1">{{ count_month }}</div>
    </div>
    <div class="bg-gray-50 p-4 rounded border">
      <div class="text-xs uppercase text-gray-500 font-semibold">This Year</div>
      <div class="text-2xl font-bold mt-1">{{ count_year }}</div>
    </div>
  </div>

  <!-- ================= GRAPH ================= -->
  <div class="mb-6 border rounded p-4">
    <div class="relative h-64">
      <canvas
        id="enquiryChart"
        class="w-full h-full"
        data-labels='{{ graph_labels|safe }}'
        data-data='{{ graph_data|safe }}'>
      </canvas>
    </div>
  </div>

  {% if enquiries %}
  <!-- Table -->
  <div class="overflow-x-auto">
    <table class="w-full text-sm border-collapse">
      <thead>
        <tr class="bg-gray-50 border-b">
          <th class="p-2 text-left">Name</th>
          <th class="p-2 text-left">Phone</th>
          <th class="p-2 text-left">Email</th>
          <th class="p-2 text-left">Submitted At</th>
        </tr>
      </thead>
      <tbody>
        {% for enquiry in enquiries %}
        <tr class="border-b hover:bg-gray-50">
          <td class="p-2">{{ enquiry.name|default:"â€”" }}</td>
          <td class="p-2">{{ enquiry.phone|default:"â€”" }}</td>
          <td class="p-2">{{ enquiry.email|default:"â€”" }}</td>
          <td class="p-2 text-xs text-gray-600">
            {{ enquiry.created_at|date:"Y-m-d H:i" }}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
    <div class="text-center p-6 text-gray-500">No enquiries yet.</div>
  {% endif %}

</div>

<!-- ================= CHART SCRIPT ================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

<script>
console.log("ğŸ”¥ Enquiry chart script injected");

(function initEnquiryChart() {

  console.log("ğŸš€ initEnquiryChart running");

  const canvas = document.getElementById("enquiryChart");

  if (!canvas) {
    console.error("âŒ enquiryChart canvas NOT FOUND");
    return;
  }

  if (typeof Chart === "undefined") {
    console.error("âŒ Chart.js NOT loaded");
    return;
  }

  console.log("âœ… Chart.js detected");

  const labelsRaw = canvas.dataset.labels;
  const dataRaw   = canvas.dataset.data;

  console.log("ğŸ“¦ Raw labels:", labelsRaw);
  console.log("ğŸ“¦ Raw data:", dataRaw);

  const labels = JSON.parse(labelsRaw || "[]");
  const data   = JSON.parse(dataRaw || "[]");

  if (!labels.length || !data.length) {
    console.warn("âš  No data for chart");
    return;
  }

  console.log("ğŸ“Š Labels:", labels);
  console.log("ğŸ“ˆ Data:", data);

  new Chart(canvas.getContext("2d"), {
    type: "line",
    data: {
      labels: labels,
      datasets: [{
        label: "Enquiries",
        data: data,
        borderColor: "#2563eb",
        backgroundColor: "rgba(37,99,235,0.3)",
        borderWidth: 2,
        tension: 0.4,
        fill: true,
        pointRadius: 4,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: { precision: 0 }
        }
      }
    }
  });

  console.log("ğŸ‰ Chart rendered SUCCESSFULLY");

})();
</script>

