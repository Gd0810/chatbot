{% include 'toast.html' %}

<div class="bg-white shadow rounded p-4">

  <!-- Header -->
  <div class="flex items-center justify-between mb-4">
    <div>
      <h2 class="text-lg font-semibold">Enquiries</h2>
      <div class="text-sm text-gray-600 mt-1">
        Total submissions: {{ enquiry_count }}
      </div>
    </div>

    <label class="flex items-center gap-2 text-sm cursor-pointer">
      <input
        type="checkbox"
        {% if workspace.enable_enquiry_form %}checked{% endif %}
        onchange="updateEnquiryFormSetting(this)"
        class="w-4 h-4"
      />
      <span>{{ workspace.enable_enquiry_form|yesno:"Enabled,Disabled" }}</span>
    </label>
  </div>

  <!-- Status -->
  <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-800">
    <strong>Form Status:</strong>
    {% if workspace.enable_enquiry_form %}
      Enquiry form is <strong>enabled</strong> — visitors will see the form before chat.
    {% else %}
      Enquiry form is <strong>disabled</strong> — visitors can chat directly.
    {% endif %}
  </div>

  <!-- Stats -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-gray-50 p-4 rounded border">
      <div class="text-xs uppercase text-gray-500 font-semibold">Today</div>
      <div class="text-2xl font-bold mt-1">{{ count_today }}</div>
    </div>
    <div class="bg-gray-50 p-4 rounded border">
      <div class="text-xs uppercase text-gray-500 font-semibold">This Month</div>
      <div class="text-2xl font-bold mt-1">{{ count_month }}</div>
    </div>
    <div class="bg-gray-50 p-4 rounded border">
      <div class="text-xs uppercase text-gray-500 font-semibold">This Year</div>
      <div class="text-2xl font-bold mt-1">{{ count_year }}</div>
    </div>
  </div>

  <!-- ================= GRAPH ================= -->
  <div class="mb-6 border rounded p-4">
    <div class="relative h-64">
      <canvas
        id="enquiryChart"
        class="w-full h-full"
        data-labels='{{ graph_labels|safe }}'
        data-data='{{ graph_data|safe }}'>
      </canvas>
    </div>
  </div>

  {% if enquiries %}
  <!-- Table -->
  <div class="overflow-x-auto">
    <table class="w-full text-sm border-collapse">
      <thead>
        <tr class="bg-gray-50 border-b">
          <th class="p-2 text-left">Name</th>
          <th class="p-2 text-left">Phone</th>
          <th class="p-2 text-left">Email</th>
          <th class="p-2 text-left">Submitted At</th>
        </tr>
      </thead>
      <tbody>
        {% for enquiry in enquiries %}
        <tr class="border-b hover:bg-gray-50">
          <td class="p-2">{{ enquiry.name|default:"—" }}</td>
          <td class="p-2">{{ enquiry.phone|default:"—" }}</td>
          <td class="p-2">{{ enquiry.email|default:"—" }}</td>
          <td class="p-2 text-xs text-gray-600">
            {{ enquiry.created_at|date:"Y-m-d H:i" }}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination Controls -->
  {% if page_obj.has_other_pages %}
  <div class="mt-6 flex items-center justify-between">
    <div class="text-sm text-gray-600">
      Showing <strong>{{ page_obj.start_index }}</strong> to <strong>{{ page_obj.end_index }}</strong> of <strong>{{ enquiry_count }}</strong> enquiries
    </div>
    <div class="flex gap-2">
      <!-- Previous Page -->
      {% if page_obj.has_previous %}
        <a href="javascript:void(0)" onclick="loadEnquiriesPage(1)" class="px-3 py-2 border rounded bg-white hover:bg-gray-50 text-sm">First</a>
        <a href="javascript:void(0)" onclick="loadEnquiriesPage({{ page_obj.previous_page_number }})" class="px-3 py-2 border rounded bg-white hover:bg-gray-50 text-sm">← Previous</a>
      {% else %}
        <button disabled class="px-3 py-2 border rounded bg-gray-100 text-gray-400 text-sm cursor-not-allowed">First</button>
        <button disabled class="px-3 py-2 border rounded bg-gray-100 text-gray-400 text-sm cursor-not-allowed">← Previous</button>
      {% endif %}

      <!-- Page Numbers -->
      <div class="flex items-center gap-1">
        {% for num in page_obj.paginator.page_range %}
          {% if page_obj.number == num %}
            <span class="px-3 py-2 border rounded bg-blue-500 text-white font-semibold text-sm">{{ num }}</span>
          {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <a href="javascript:void(0)" onclick="loadEnquiriesPage({{ num }})" class="px-3 py-2 border rounded bg-white hover:bg-gray-50 text-sm">{{ num }}</a>
          {% endif %}
        {% endfor %}
      </div>

      <!-- Next Page -->
      {% if page_obj.has_next %}
        <a href="javascript:void(0)" onclick="loadEnquiriesPage({{ page_obj.next_page_number }})" class="px-3 py-2 border rounded bg-white hover:bg-gray-50 text-sm">Next →</a>
        <a href="javascript:void(0)" onclick="loadEnquiriesPage({{ page_obj.paginator.num_pages }})" class="px-3 py-2 border rounded bg-white hover:bg-gray-50 text-sm">Last</a>
      {% else %}
        <button disabled class="px-3 py-2 border rounded bg-gray-100 text-gray-400 text-sm cursor-not-allowed">Next →</button>
        <button disabled class="px-3 py-2 border rounded bg-gray-100 text-gray-400 text-sm cursor-not-allowed">Last</button>
      {% endif %}
    </div>
  </div>
  {% endif %}

  {% else %}
    <div class="text-center p-6 text-gray-500">No enquiries yet.</div>
  {% endif %}

</div>

<script>
    (function() {
        // Enquiries Chart Initialization
        function initEnquiryChart() {
            const ctx = document.getElementById('enquiryChart');
            if (!ctx) return;

            // Destroy existing chart if any
            if (window.myEnquiryChart) {
                window.myEnquiryChart.destroy();
                window.myEnquiryChart = null;
            }

            try {
                // Get data from data attributes safely
                const labelsRaw = ctx.dataset.labels;
                const dataRaw = ctx.dataset.data;

                if (!labelsRaw || !dataRaw) return;

                const labels = JSON.parse(labelsRaw);
                const data = JSON.parse(dataRaw);

                if (labels && data && labels.length > 0) {
                     window.myEnquiryChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Enquiries',
                                data: data,
                                borderColor: '#4F46E5', // Indigo 600
                                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                                tension: 0.3,
                                fill: true,
                                pointRadius: 3,
                                pointHoverRadius: 5
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: { mode: 'index', intersect: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { stepSize: 1 },
                                    grid: { color: 'rgba(0, 0, 0, 0.05)' }
                                },
                                x: { grid: { display: false } }
                            }
                        }
                    });
                }
            } catch (e) {
                console.error("Error initializing chart:", e);
            }
        }

        // Run immediately
        initEnquiryChart();
    })();
</script>

